package com.merits.modules.base.site.servlets;

import com.merits.core.MeritsUtils;
import com.merits.modules.base.container.BaseContainer;
import com.merits.modules.base.dao.ShopCashiersDAO;
import com.merits.modules.base.dao.ShopsDAO;
import com.merits.modules.base.dao.VolunteersDAO;
import com.merits.modules.base.site.servlets.definitions.LoginServletDefinition;
import com.merits.modules.base.uobjects.enums.MeritsUserType;
import com.weezzi.core.context.AjaxServletContext;
import com.weezzi.core.security.sessions.SecurityAccess;
import com.weezzi.core.session.WeezziSession;

/**
 * <b>Title: </b> LoginServlet<br/>
 * <b>Description: </b> LoginServlet<br/>
 *
 * @author Auto-generated by Weezzi Site Builder
 * @version 1.0
 */
@SuppressWarnings("unused")
public class LoginServlet extends LoginServletDefinition {


	// SERVLET ----------------------------------------------------------------

	
	/**
	 * Initializes the servlet
	 */
	public void initializeServlet() {
		// Local Variables
		
	}

	/**
	 * Destroys the servlet
	 */
	public void destroyServlet() {
		// Local Variables
		
	}


	// PUBLIC -----------------------------------------------------------------

    /**
     * VolunteerLogin action
     */
    protected void volunteerLogin(AjaxServletContext context, String username, String password, boolean rememberMe) throws Exception {
        // Local Variables
    	WeezziSession session;
    	VolunteersDAO volunteer;
    	// Get volunteer
    	volunteer = BaseContainer.getVolunteerFindByLogin(VolunteersDAO.getEncryptedLoginEmail(username));
    	if (volunteer == null || !volunteer.getLoginPassword().equals(password) || volunteer.getIsBlocked()) {
        	writeScript(context, "notFound()");
    	} else {    	
    		session = context.getSession();
    		MeritsUtils.loginVolunteer(session, volunteer);
    		if (rememberMe) {
    			context.setPersistentCookieEncrypted(MeritsUtils.REMEMBER_COOKIE, "V_" + volunteer.getId(), 120);
    		}
        	redirect(context, getPageLink(context, "Volunteers_Home"));
    	}
    	
    }


    /**
     * ShopLogin action
     */
    protected void shopLogin(AjaxServletContext context, long shopId, String username, String password, boolean rememberMe) throws Exception {
        // Local Variables
    	ShopsDAO shop;
    	ShopCashiersDAO cashier;
    	WeezziSession session;
    	// Get volunteer
    	shop = BaseContainer.getShop(shopId);
    	if (shop == null) {
        	writeScript(context, "notFound()");
        	return;
    	} else {
    		// Check if is owner
    		if (shop.getOwnerLogin().equals(username)) {
    			// OWNER
    			if (!shop.getOwnerPassword().equals(password)) {
    	        	writeScript(context, "notFound()");
    	        	return;
    			}
        		session = context.getSession();
        		MeritsUtils.loginShopOwner(session, shop);
        		if (rememberMe) {
        			context.setPersistentCookieEncrypted(MeritsUtils.REMEMBER_COOKIE, "S_" + shop.getId(), 120);
        		}
            	redirect(context, getPageLink(context, "Shops_Home"));
    		} else {
    			// CASHIER
    			cashier = BaseContainer.getShopCashierFindByUsername(shopId, ShopCashiersDAO.getEncryptedLoginUsername(username));
    			if (cashier == null) {
    	        	writeScript(context, "notFound()");
    	        	return;
    			}
    			if (!cashier.getLoginPassword().equals(password)) {
    	        	writeScript(context, "notFound()");
    	        	return;
    			}
        		session = context.getSession(); 
        		MeritsUtils.loginCashier(session, shop, cashier);
        		if (rememberMe) {
        			context.setPersistentCookieEncrypted(MeritsUtils.REMEMBER_COOKIE, "C_" + shop.getId() + "_" + cashier.getId(), 120);
        		}
            	redirect(context, getPageLink(context, "Cashiers_Home"));
    		}
    		
    	}
    }



}
