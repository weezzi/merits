package com.merits.modules.base.site.components;

import com.merits.core.MeritsUtils;
import com.merits.core.WalletTransactionInfo;
import com.merits.modules.base.container.BaseContainer;
import com.merits.modules.base.dao.BulkShopTransactionsDAO;
import com.merits.modules.base.dao.ShopTransactionsDAO;

//IMPORTS -------------------------------------------------------------------------

import com.merits.modules.base.site.components.definitions.CashiersPaymentsDefinition;
import com.weezzi.utils.extras.console.Console;
import com.weezzi.webserver.simel.AttributeMapper;
import com.weezzi.webserver.simel.Expression;


/**
 * <b>Title: </b> CashiersPayments<br/>
 * <b>Description: </b> <br/>
 *
 * @author Auto-generated by Weezzi Site Builder
 * @version 1.0
 */
public class CashiersPayments extends CashiersPaymentsDefinition {


	// CONSTANTS ---------------------------------------------------------------

	
	// INITIALIZATION ----------------------------------------------------------
	
	
	public void customComponentInitialization() {
	};


	// BROWSER OUTPUT ----------------------------------------------------------


	/**
	 * Generate Start Output
	 * @return String
	 */
	public String getStartOutput() {
		// Local Variables
		Expression expr;
		AttributeMapper map;
		// Get Expression
		expr = getHTMLExpression("Default");
		map = expr.getAttributeMapper();
		// Add attributes
		map.addAttribute("PAYMENTS", renderPayments());
		// Render
		return expr.render(map);
	}

	
	// PRIVATE ----------------------------------------------------------------


	/**
	 * @return
	 */
	private String renderPayments() {
		// Local Variables
		Expression expr;
		AttributeMapper map;
		BulkShopTransactionsDAO records;
		WalletTransactionInfo info;
		StringBuilder buffer = new StringBuilder();
		// Get Expression
		expr = getHTMLExpression("Payment");
		map = expr.getAttributeMapper();
		try {
			records = BaseContainer.getShopTransactionsFindByShopCashier(MeritsUtils.getShopId(getContext()), getSiteUserId());
		} catch (Exception e) {
			// Catch Exception
			Console.error("Error getting cashier transactions for cashier \"" + getSiteUserId() + "\"", e);;
			return "";
		}
		// Render records
		for(ShopTransactionsDAO rec : records.data) {
			info = MeritsUtils.getReferenceTransactionInfo(rec, getSiteLanguage());
			map.addAttribute("ID", encryptData(rec.getId()));
			map.addAttribute("DATE", info.getDate());
			map.addAttribute("NAME", info.getName());
			map.addAttribute("PHOTO", info.getPhoto());
			map.addAttribute("CASHIER", info.getCashier());
			map.addAttribute("VALUE_DEC", info.getValueDecimal());
			map.addAttribute("VALUE_INT", info.getValueInteger());
			buffer.append(expr.render(map));
		}
		// Check if no payments yet
		if (buffer.length() == 0) {
			buffer.append(getHTML("NoPayments"));
		}
		// Render
		return buffer.toString();
	}

}

