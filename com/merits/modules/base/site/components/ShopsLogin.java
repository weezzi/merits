package com.merits.modules.base.site.components;

import com.merits.core.MeritsUtils;
import com.merits.modules.base.container.BaseContainer;
import com.merits.modules.base.dao.BulkShopsDAO;
import com.merits.modules.base.dao.ShopCashiersDAO;
import com.merits.modules.base.dao.ShopsDAO;

//IMPORTS -------------------------------------------------------------------------

import com.merits.modules.base.site.components.definitions.ShopsLoginDefinition;
import com.weezzi.utils.extras.console.Console;
import com.weezzi.webserver.simel.AttributeMapper;
import com.weezzi.webserver.simel.Expression;


/**
 * <b>Title: </b> ShopsLogin<br/>
 * <b>Description: </b> <br/>
 *
 * @author Auto-generated by Weezzi Site Builder
 * @version 1.0
 */
public class ShopsLogin extends ShopsLoginDefinition {


	// CONSTANTS ---------------------------------------------------------------

	
	// INITIALIZATION ----------------------------------------------------------
	
	
	public void customComponentInitialization() {
		addGlobalStyle("MeritsApp");
		addScript("Scripts");
	};


	// BROWSER OUTPUT ----------------------------------------------------------


	/**
	 * Generate Start Output
	 * @return String
	 */
	public String getStartOutput() {
		// Local Variables
		String cookie;
		Expression expr;
		AttributeMapper map;
		ShopsDAO shop;
		ShopCashiersDAO cashier;
		Long shopId = null, cashierId = null;
		// Check remember me cookie
		if (getContext().getCookie(MeritsUtils.REMEMBER_COOKIE) != null) {
			try {
				cookie = getContext().getEncryptedCookie(MeritsUtils.REMEMBER_COOKIE);
				if (cookie.startsWith("S_")) {
					// SHOP
					shopId = Long.parseLong(cookie.substring(2));
					shop = BaseContainer.getShop(shopId);
					if (shop != null) {
						MeritsUtils.loginShopOwner(getSession(), shop);
						sendRedirect(getPageLink("Shops_Home"));
						return "";
					}
				} else if (cookie.startsWith("C_")) {
					shopId = Long.parseLong(cookie.substring(2, cookie.indexOf("_", 3)));
					cashierId = Long.parseLong(cookie.substring(cookie.indexOf("_", 3)));
					shop = BaseContainer.getShop(shopId);
					cashier = BaseContainer.getShopCashier(cashierId);
					if (shop != null && cashier != null) {
						MeritsUtils.loginCashier(getSession(), shop, cashier);
						sendRedirect(getPageLink("Cashiers_Home"));
						return "";
					}
				}
			} catch (Exception e) {
				// Catch Exception
				Console.error("Cookie get error",e);
			}
		}
		// Get Expression
		expr = getHTMLExpression("Default");
		map = expr.getAttributeMapper();
		// Add attributes
		map.addAttribute("SHOPS", renderAllShops());
		// Render
		return expr.render(map);
	}

	
	// PRIVATE ----------------------------------------------------------------


	/**
	 * @return
	 */
	private String renderAllShops() {
		// Local Variables
		Expression expr;
		AttributeMapper map;
		BulkShopsDAO shops;
		StringBuilder buffer = new StringBuilder();
		// Get Expression
		expr = getHTMLExpression("Shop");
		map = expr.getAttributeMapper();
		try {
			shops = BaseContainer.getShopsFindByGetAll();
			for(ShopsDAO shop : shops.data) {
				map.addAttribute("ID", encryptData(shop.getId()));
				map.addAttribute("NAME", shop.getName());
				buffer.append(expr.render(map));
			}
		} catch (Exception e) {
			// Catch Exception
			Console.error("Error getting shops", e);
			return "";
		}
		
		
		return buffer.toString();
	}


}

